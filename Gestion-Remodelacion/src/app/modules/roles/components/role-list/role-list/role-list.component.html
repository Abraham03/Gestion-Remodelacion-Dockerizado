<div class="page-container">
  <div class="table-header">
    <h2>{{ 'ROLES.MANAGEMENT' | translate }}</h2>
    <div class="table-actions">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>{{ 'ROLES.SEARCH_ROLE' | translate }}</mat-label>
        <input matInput [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" (keyup.enter)="applyFilter()" [placeholder]="'ROLES.SEARCH_PLACEHOLDER' | translate">
        <mat-icon matSuffix (click)="applyFilter()">search</mat-icon>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="openRoleForm()" *ngIf="hasPermission('ROLE_CREATE')">
        <mat-icon>add</mat-icon> {{ 'ROLES.CREATE_ROLE' | translate }}
      </button>
    </div>
  </div>

  <div class="table-card">

    <mat-progress-bar 
      *ngIf="loading$ | async" 
      mode="indeterminate" 
      class="table-loading-bar">
    </mat-progress-bar>

    <div class="table-container">
      <table mat-table [dataSource]="(roles$ | async) || []" (matSortChange)="onSortChange($event)" class="responsive-table" matSort (matSortChange)="onSortChange($event)">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'ROLES.NAME' | translate }}</th>
          <td mat-cell *matCellDef="let role">{{ role.name }}</td>
        </ng-container>
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'ROLES.DESCRIPTION' | translate }}</th>
          <td mat-cell *matCellDef="let role">{{ role.description }}</td>
        </ng-container>
        <ng-container matColumnDef="permissions">
          <th mat-header-cell *matHeaderCellDef>{{ 'ROLES.PERMISSIONS' | translate }}</th>
          <td mat-cell *matCellDef="let role">
            <button mat-button color="primary" (click)="viewPermissions(role)" [matTooltip]="'ROLES.VIEW_PERMISSIONS' | translate">
              <span *ngIf="role.permissions && role.permissions.length > 0">{{ 'ROLES.VIEW_PERMISSIONS_COUNT' | translate:{ count: role.permissions.length } }}</span>
              <span *ngIf="!role.permissions || role.permissions.length === 0">{{ 'ROLES.NO_PERMISSIONS' | translate }}</span>
            </button>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'GLOBAL.ACTIONS' | translate }}</th>
          <td mat-cell *matCellDef="let role" class="mat-column-acciones">
            <button mat-icon-button color="accent" (click)="openRoleForm(role)" *ngIf="hasPermission('ROLE_UPDATE')" [matTooltip]="'GLOBAL.EDIT' | translate">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteRole(role.id!)" *ngIf="hasPermission('ROLE_DELETE')" [matTooltip]="'GLOBAL.DELETE' | translate">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            {{ 'ROLES.NO_RECORDS_FOUND' | translate }}
          </td>
        </tr>
      </table>
    </div>
    <mat-paginator 
    [length]="totalElements$ | async" 
    [pageSize]="pageSize$ | async" 
    [pageIndex]="currentPage$ | async"
    [pageSizeOptions]="[5, 10, 20]" 
    (page)="onPageChange($event)" showFirstLastButtons
    class="table-paginator"></mat-paginator>
  </div>
</div>