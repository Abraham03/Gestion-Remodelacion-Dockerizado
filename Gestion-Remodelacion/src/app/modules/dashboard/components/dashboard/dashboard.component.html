@if (!(isLoading$ | async)) {
<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>{{ 'DASHBOARD.TITLE' | translate }}</h1>
    <p class="subtitle">{{ 'DASHBOARD.SUBTITLE' | translate }}</p>
  </header>

  <mat-card class="global-filters-card">
    <div class="filter-group">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'DASHBOARD.YEAR_GENERAL' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedYear" (selectionChange)="onYearChange()">
          @for (year of (years$ | async); track year) { <mat-option [value]="year">{{ year }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'DASHBOARD.MONTH_GENERAL' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedMonth" (selectionChange)="onMonthChange()">
          @for (month of availableMonths; track month.value) { <mat-option [value]="month.value">{{ month.viewValue }}</mat-option> }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'DASHBOARD.PROJECT' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedProjectId" (selectionChange)="onProjectChange()">
          <mat-option [value]="null">{{ 'DASHBOARD.ALL_PROJECTS' | translate }}</mat-option>
          @for (proyecto of availableProjects; track proyecto.id) {
            <mat-option [value]="proyecto.id">{{ proyecto.nombre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  @if (dashboardQuery.summary$ | async; as summary) {
  <h2 class="section-title">{{ 'DASHBOARD.KEY_INDICATORS' | translate }}</h2>
  <div class="kpi-grid">
    <mat-card class="kpi-card">
      <div class="kpi-icon-container color-success"><mat-icon class="kpi-icon">account_balance_wallet</mat-icon></div>
      <div class="kpi-content">
        <p class="kpi-title">{{ 'DASHBOARD.GENERAL_BALANCE' | translate }}</p>
        <p class="kpi-value">{{ (summary.balanceFinanciero || 0) | currency:'USD' }}</p>
      </div>
    </mat-card>
    <mat-card class="kpi-card">
      <div class="kpi-icon-container color-info"><mat-icon class="kpi-icon">trending_up</mat-icon></div>
      <div class="kpi-content">
        <p class="kpi-title">{{ 'DASHBOARD.TOTAL_INCOME' | translate }}</p>
        <p class="kpi-value">{{ (summary.montoRecibido || 0) | currency:'USD' }}</p>
      </div>
    </mat-card>
    <mat-card class="kpi-card">
      <div class="kpi-icon-container color-warn"><mat-icon class="kpi-icon">trending_down</mat-icon></div>
      <div class="kpi-content">
        <p class="kpi-title">{{ 'DASHBOARD.COSTS_AND_EXPENSES' | translate }}</p>
        <p class="kpi-value">{{ (summary.costoMateriales + summary.otrosGastos + summary.costoManoDeObra || 0) | currency:'USD' }}</p>
      </div>
    </mat-card>
    <mat-card class="kpi-card">
      <div class="kpi-icon-container color-primary"><mat-icon class="kpi-icon">assignment</mat-icon></div>
      <div class="kpi-content">
        <p class="kpi-title">{{ 'DASHBOARD.TOTAL_PROJECTS' | translate }}</p>
        <p class="kpi-value">{{ summary.totalProyectos || 0 }}</p>
      </div>
    </mat-card>
    <mat-card class="kpi-card">
      <div class="kpi-icon-container color-accent"><mat-icon class="kpi-icon">people</mat-icon></div>
      <div class="kpi-content">
        <p class="kpi-title">{{ 'DASHBOARD.ACTIVE_EMPLOYEES' | translate }}</p>
        <p class="kpi-value">{{ summary.empleadosActivos || 0 }}</p>
      </div>
    </mat-card>
  </div>
  }

  <h2 class="section-title">{{ 'DASHBOARD.VISUALIZATIONS' | translate }}</h2>
  <mat-grid-list [cols]="cols" rowHeight="420px" gutterSize="24px">
    <mat-grid-tile>
      <mat-card class="chart-card">
        <mat-card-header><mat-card-title>{{ 'DASHBOARD.CHART_PROJECTS_BY_STATUS' | translate }}</mat-card-title></mat-card-header>
        <mat-card-content><div class="chart-container"><canvas id="estadoProyectosChart"></canvas></div></mat-card-content>
      </mat-card>
    </mat-grid-tile>
    <mat-grid-tile>
      <mat-card class="chart-card">
        <mat-card-header><mat-card-title>{{ 'DASHBOARD.CHART_EMPLOYEES_BY_ROLE' | translate }}</mat-card-title></mat-card-header>
        <mat-card-content><div class="chart-container"><canvas id="empleadosPorRolChart"></canvas></div></mat-card-content>
      </mat-card>
    </mat-grid-tile>
    
    <mat-grid-tile [colspan]="cols === 1 ? 1 : 2">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>{{ 'DASHBOARD.CHART_CLIENT_ACQUISITION' | translate }} ({{ selectedYear }})</mat-card-title>
        </mat-card-header>
        <mat-card-content><div class="chart-container"><canvas id="clientesPorMesChart"></canvas></div></mat-card-content>
      </mat-card>
    </mat-grid-tile>

    <mat-grid-tile [colspan]="cols === 1 ? 1 : 2">
      <mat-card class="chart-card">
        <mat-card-header><mat-card-title>{{ 'DASHBOARD.CHART_TOP_5_PROJECTS' | translate }}</mat-card-title></mat-card-header>
        <mat-card-content><div class="chart-container"><canvas id="horasPorProyectoChart"></canvas></div></mat-card-content>
      </mat-card>
    </mat-grid-tile>
  </mat-grid-list>

  <div class="table-card">
    <div class="table-header">
      <h2>{{ 'DASHBOARD.DETAILED_HOURS_LOG' | translate }}</h2>
    </div>
    <div class="table-filter">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'DASHBOARD.SEARCH_IN_RECORDS' | translate }}</mat-label>
        <input matInput #input (keyup)="applyFilter(input.value)" (input)="applyFilter(input.value)">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort>
        <ng-container matColumnDef="empleado"><th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'DASHBOARD.TABLE.EMPLOYEE' | translate }}</th><td mat-cell *matCellDef="let row">{{ row.nombreEmpleado }}</td></ng-container>
        <ng-container matColumnDef="proyecto"><th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'DASHBOARD.TABLE.PROJECT' | translate }}</th><td mat-cell *matCellDef="let row">{{ row.nombreProyecto }}</td></ng-container>
        <ng-container matColumnDef="horas"><th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'DASHBOARD.TABLE.HOURS_REGISTERED' | translate }}</th><td mat-cell *matCellDef="let row">{{ row.horas | number:'1.2-2' }}h</td></ng-container>
        <ng-container matColumnDef="montoTotal"><th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'DASHBOARD.TABLE.TOTAL_AMOUNT' | translate }}</th><td mat-cell *matCellDef="let row">{{ row.montoTotal | currency:'USD' }}</td></ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr class="mat-row" *matNoDataRow><td class="mat-cell" colspan="4">{{ 'DASHBOARD.NO_RECORDS_FOUND_FILTER' | translate: { filter: input.value } }}</td></tr>
      </table>
    </div>
    <mat-paginator class="table-paginator" [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
  </div>
</div>
} @else {
<div class="loading-shade">
  <mat-spinner></mat-spinner>
  <p>{{ 'DASHBOARD.LOADING_DATA' | translate }}</p>
</div>
}